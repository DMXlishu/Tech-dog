<!doctype html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<title>机器狗 - 完整排队系统</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<style>
/*========== 基础 ==========*/
*{box-sizing:border-box;margin:0;padding:0}
body{display:flex;flex-direction:column;height:100vh;background:#f7f7f7;font-family:-apple-system,"Helvetica Neue",Arial;}
.page{flex:1;overflow-y:auto;padding:20px 20px 120px;display:none}
.page.active{display:block}
.tabbar{display:flex;height:52px;background:#fff;border-top:1px solid #000}
.tabbar .item{flex:1;display:flex;align-items:center;justify-content:center;cursor:pointer;font-size:15px;color:#333;border-right:1px solid #000}
.tabbar .item:last-child{border-right:none}
.tabbar .item.active{background:#000;color:#fff}
.btn-fixed{position:fixed;bottom:60px;left:0;right:0;display:flex;justify-content:center;gap:20px;pointer-events:none}
.btn-fixed .btn{pointer-events:auto;width:140px;height:46px;line-height:46px;text-align:center;font-size:16px;font-weight:bold;color:#000;background:#FFD700;border:2px solid #000;border-radius:12px;box-shadow:0 4px 8px rgba(0,0,0,.25),inset 0 -2px 4px rgba(255,255,255,.6),inset 0 2px 4px rgba(0,0,0,.2);cursor:pointer}

/*========== 弹窗通用 ==========*/
.modal{position:fixed;inset:0;background:rgba(0,0,0,.45);display:none;align-items:center;justify-content:center;z-index:999}
.modal.active{display:flex}
.modal-content{background:#fff;border-radius:10px;padding:25px 30px;min-width:280px;max-width:90%;text-align:center;box-shadow:0 8px 20px rgba(0,0,0,.3)}
.modal-content h3{margin-bottom:18px;font-size:18px}
.modal-content button{width:100%;margin:8px 0;padding:10px 0;font-size:15px;border:1px solid #ccc;border-radius:6px;background:#fff;cursor:pointer}
.modal-content button.primary{background:#000;color:#fff;border:#000}
video{width:100%;max-width:400px}

/*========== 主页底部实时信息栏 ==========*/
#liveInfo{position:fixed;bottom:120px;left:0;right:0;background:#ffe58a;border-top:2px solid #000;text-align:center;font-size:16px;font-weight:bold;padding:8px 0;z-index:10}

/*========== 后台表格 ==========*/
table{width:100%;border-collapse:collapse;margin-top:10px}
th,td{border:1px solid #aaa;padding:6px 4px;font-size:13px;text-align:center}
th{background:#eee}
tr:first-child td.orderNum{color:red;font-weight:bold}
#adminSum{font-weight:bold;margin-top:8px}

/*========== 右下角清除按钮 ==========*/
#clearBtn{position:fixed;bottom:80px;right:20px;background:#ff4d4f;color:#fff;border:none;border-radius:6px;padding:8px 12px;font-size:13px;cursor:pointer;box-shadow:0 2px 6px rgba(0,0,0,.3)}
</style>
</head>
<body>
<!-- 三个页面 -->
<div id="my"   class="page"><h2>我的</h2><p>登录/订单记录等</p></div>
<div id="home" class="page active">
    <h2>首页</h2>
    <video src="video1.mp4" controls width="100%"></video>
    <p>扫码、取号、玩法视频、支付按钮都可以放在这。</p>
    <!-- 模拟支付 -->
    <button onclick="simulatePay(1)">模拟支付1（10元/30分钟）</button>
    <button onclick="simulatePay(2)">模拟支付2（5元/10分钟）</button>
</div>
<div id="agreement" class="page"><h2>用户协议</h2><p>机器狗游玩须知、免责条款写这里。</p></div>

<!-- 底部固定按钮 -->
<div class="btn-fixed">
    <div class="btn" id="btnWantPlay">我要玩</div>
    <div class="btn">我要挑战</div>
</div>

<!-- 底部导航 -->
<nav class="tabbar">
    <div class="item" data-page="my">我的</div>
    <div class="item active" data-page="home">首页</div>
    <div class="item" data-page="agreement">用户协议</div>
</nav>

<!-- 主页实时排队信息 -->
<div id="liveInfo">当前编号----，还有----人，预计--:--</div>

<!-- ========== 弹窗区域 ========== -->
<!-- 1. 一级：观看视频 or 直接玩 -->
<div class="modal" id="modalFirst"><div class="modal-content">
    <h3>选择操作</h3>
    <button id="watchVideoBtn">观看操控视频</button>
    <button id="directPlayBtn" class="primary">直接玩</button>
</div></div>

<!-- 2. 视频播放 -->
<div class="modal" id="modalVideo"><div class="modal-content">
    <h3>操控演示</h3>
    <video src="video2.mp4" controls></video>
    <button onclick="closeModal('modalVideo')">关闭</button>
</div></div>

<!-- 3. 选择套餐 -->
<div class="modal" id="modalPrice"><div class="modal-content">
    <h3>选择套餐</h3>
    <button data-price="10" data-time="30">10元 / 30分钟</button>
    <button data-price="5"  data-time="10">5元 / 10分钟</button>
    <button onclick="closeModal('modalPrice')">取消</button>
</div></div>

<!-- 4. 支付方式 -->
<div class="modal" id="modalPay"><div class="modal-content">
    <h3>选择支付方式</h3>
    <button class="payOption" data-channel="wechat">微信</button>
    <button class="payOption" data-channel="alipay">支付宝</button>
    <button class="payOption" data-channel="bank">银行卡</button>
    <button onclick="closeModal('modalPay')">返回</button>
</div></div>

<!-- 5. 排队中 -->
<div class="modal" id="modalQueue"><div class="modal-content">
    <h3>排队中</h3>
    <p>您的编号：<span id="queueNum">----</span></p>
    <p>前面还有 <span id="queueAhead">--</span> 人</p>
    <p>预计等待时间：<span id="queueTime">--:--</span></p>
    <button onclick="closeModal('modalQueue')">关闭</button>
</div></div>

<!-- 6. 后台表格 -->
<div class="modal" id="modalAdmin"><div class="modal-content" style="min-width:90%;max-height:80vh;overflow-y:auto">
    <h3>每日订单 & 收益</h3>
    <table id="adminTable">
        <thead><tr><th>编号</th><th>日期</th><th>订单号</th><th>套餐</th><th>本单收益</th><th>总收益</th></tr></thead>
        <tbody></tbody>
    </table>
    <div id="adminSum"></div>
    <button onclick="closeModal('modalAdmin')">关闭</button>
</div></div>

<!-- 7. 清除数据确认 -->
<div class="modal" id="modalClear"><div class="modal-content">
    <h3>确定清除所有数据？</h3>
    <p>编号将重新从 1 开始，总收益归零且不可恢复！</p>
    <button onclick="clearData()" class="primary">确定</button>
    <button onclick="closeModal('modalClear')">取消</button>
</div></div>

<!-- 右下角清除按钮 -->
<button id="clearBtn" onclick="openModal('modalClear')">一键清除数据</button>

<script>
/*========== 工具：打开 / 关闭弹窗 ==========*/
function openModal(id){ closeAllModal(); document.getElementById(id).classList.add('active'); }
function closeModal(id){ document.getElementById(id).classList.remove('active'); }
function closeAllModal(){ document.querySelectorAll('.modal').forEach(m=>m.classList.remove('active')); }
document.querySelectorAll('.modal').forEach(modal=>{ modal.addEventListener('click',function(e){ if(e.target===modal) closeModal(modal.id); }); });

/*========== 底部导航切换 ==========*/
document.querySelectorAll('.tabbar .item').forEach(btn=>{
    btn.addEventListener('click', function(){
        document.querySelectorAll('.tabbar .item').forEach(b=>b.classList.remove('active'));
        this.classList.add('active');
        document.querySelectorAll('.page').forEach(p=>p.classList.remove('active'));
        document.getElementById(this.dataset.page).classList.add('active');
        if(this.dataset.page==='my'){ loadAdmin(); openModal('modalAdmin'); } // 进入“我的”=后台
    });
});

/*========== 我要玩 ==========*/
document.getElementById('btnWantPlay').onclick = ()=> openModal('modalFirst');
document.getElementById('watchVideoBtn').onclick = ()=>{ closeModal('modalFirst'); openModal('modalVideo'); };
document.getElementById('directPlayBtn').onclick = ()=>{ closeModal('modalFirst'); openModal('modalPrice'); };

/*========== 支付流程 ==========*/
let currentPrice=0, currentTime=0;
document.querySelectorAll('#modalPrice button[data-price]').forEach(btn=>{
    btn.addEventListener('click',function(){
        currentPrice = this.dataset.price;
        currentTime  = this.dataset.time;
        closeModal('modalPrice');
        openModal('modalPay');
    });
});
document.querySelectorAll('.payOption').forEach(btn=>{
    btn.addEventListener('click',function(){
        const channel = this.dataset.channel;
        /* 此处放真实支付链接 */
        if(channel==='wechat')  location.href='【这里放微信支付链接】';
        if(channel==='alipay')  location.href='【这里放支付宝链接】';
        if(channel==='bank')    location.href='【这里放银行卡链接】';
        // 演示：直接当成功
        closeModal('modalPay');
        createOrder(currentPrice,currentTime);
    });
});

/*========== 模拟支付按钮（测试用） ==========*/
function simulatePay(type){
    const price = type===1?10:5;
    const time  = type===1?30:10;
    createOrder(price,time);
}

/*========== 创建订单 → 排队 ==========*/
async function createOrder(price,time){
    const res = await fetch('/api/createOrder',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({price,time})});
    const data = await res.json();
    if(data.ok){
        updateLiveInfo(data);
        openModal('modalQueue');
        // 每5秒刷新一次排队信息
        const t = setInterval(async ()=>{
            const r = await fetch('/api/queueInfo?id='+data.id);
            const d = await r.json();
            if(d.ok){ updateLiveInfo(d); }else{ clearInterval(t); }
        },5000);
    }else{
        alert('订单创建失败：'+data.msg);
    }
}
function updateLiveInfo(d){
    document.getElementById('queueNum').textContent  = d.orderNum;
    document.getElementById('queueAhead').textContent= d.ahead;
    document.getElementById('queueTime').textContent = d.waitTime;
    document.getElementById('liveInfo').textContent  = `当前编号${d.orderNum}，还有${d.ahead}人，预计排队${d.waitTime}`;
}

/*========== 后台表格加载 ==========*/
async function loadAdmin(){
    const res = await fetch('/api/admin');
    const data = await res.json();
    const tbody = document.querySelector('#adminTable tbody');
    tbody.innerHTML='';
    data.rows.forEach((r,i)=>{
        const tr = document.createElement('tr');
        if(i===0) tr.classList.add('firstRow');
        tr.innerHTML=`
            <td>${r.id}</td>
            <td>${r.date}</td>
            <td class="orderNum">${r.orderNum}</td>
            <td>${r.plan}</td>
            <td>${r.price}元</td>
            <td>${r.total}元</td>`;
        tbody.appendChild(tr);
    });
    document.getElementById('adminSum').textContent = `总收益：${data.total} 元`;
}

/*========== 一键清除数据 ==========*/
async function clearData(){
    const res = await fetch('/api/clear',{method:'POST'});
    const data = await res.json();
    if(data.ok){ alert('已清空！'); closeModal('modalClear'); loadAdmin(); }
}
</script>
</body>
</html>