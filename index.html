<!doctype html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<title>机器狗 - 完整排队系统</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<style>
/*========== 基础 ==========*/
*{box-sizing:border-box;margin:0;padding:0}
body{display:flex;flex-direction:column;height:100vh;background:#f7f7f7;font-family:-apple-system,"Helvetica Neue",Arial;}
.page{flex:1;overflow-y:auto;padding:20px 20px 120px;display:none}
.page.active{display:block}
.tabbar{display:flex;height:52px;background:#fff;border-top:1px solid #000}
.tabbar .item{flex:1;display:flex;align-items:center;justify-content:center;cursor:pointer;font-size:15px;color:#333;border-right:1px solid #000}
.tabbar .item:last-child{border-right:none}
.tabbar .item.active{background:#000;color:#fff}
.btn-fixed{position:fixed;bottom:60px;left:0;right:0;display:flex;justify-content:center;gap:20px;pointer-events:none}
.btn-fixed .btn{pointer-events:auto;width:140px;height:46px;line-height:46px;text-align:center;font-size:16px;font-weight:bold;color:#000;background:#FFD700;border:2px solid #000;border-radius:12px;box-shadow:0 4px 8px rgba(0,0,0,.25),inset 0 -2px 4px rgba(255,255,255,.6),inset 0 2px 4px rgba(0,0,0,.2);cursor:pointer}

/*========== 弹窗通用 ==========*/
.modal{position:fixed;inset:0;background:rgba(0,0,0,.45);display:none;align-items:center;justify-content:center;z-index:999}
.modal.active{display:flex}
.modal-content{background:#fff;border-radius:10px;padding:25px 30px;min-width:280px;max-width:90%;text-align:center;box-shadow:0 8px 20px rgba(0,0,0,.3)}
.modal-content h3{margin-bottom:18px;font-size:18px}
.modal-content button{width:100%;margin:8px 0;padding:10px 0;font-size:15px;border:1px solid #ccc;border-radius:6px;background:#fff;cursor:pointer}
.modal-content button.primary{background:#000;color:#fff;border:#000}
video{width:100%;max-width:400px}

/*========== 主页底部实时信息栏 ==========*/
#liveInfo{position:fixed;bottom:120px;left:0;right:0;background:#ffe58a;border-top:2px solid #000;text-align:center;font-size:16px;font-weight:bold;padding:8px 0;z-index:10}

/*========== 加载动画 ==========*/
.loading{display:inline-block;width:20px;height:20px;border:3px solid #f3f3f3;border-top:3px solid #000;border-radius:50%;animation:spin 1s linear infinite}
@keyframes spin{0%{transform:rotate(0deg)}100%{transform:rotate(360deg)}}

/*========== 响应式设计 ==========*/
@media (max-width: 768px){
    .btn-fixed .btn{width:120px;height:40px;line-height:40px;font-size:14px}
    .modal-content{padding:20px;min-width:250px}
    #liveInfo{font-size:14px;bottom:110px}
}
</style>
</head>
<body>
<!-- 三个页面 -->
<div id="my" class="page"><h2>我的</h2><p>登录/订单记录等</p></div>
<div id="home" class="page active">
    <h2>首页</h2>
    <video src="video1.mp4" controls width="100%"></video>
    <p>扫码、取号、玩法视频、支付按钮都可以放在这。</p>
    <!-- 模拟支付 -->
    <button onclick="simulatePay(1)">模拟支付1（10元/30分钟）</button>
    <button onclick="simulatePay(2)">模拟支付2（5元/10分钟）</button>
</div>
<div id="agreement" class="page"><h2>用户协议</h2><p>机器狗游玩须知、免责条款写这里。</p></div>

<!-- 底部固定按钮 -->
<div class="btn-fixed">
    <div class="btn" id="btnWantPlay">我要玩</div>
    <div class="btn">我要挑战</div>
</div>

<!-- 底部导航 -->
<nav class="tabbar">
    <div class="item" data-page="my">我的</div>
    <div class="item active" data-page="home">首页</div>
    <div class="item" data-page="agreement">用户协议</div>
</nav>

<!-- 主页实时排队信息 -->
<div id="liveInfo">当前编号----，还有----人，预计--:--</div>

<!-- ========== 弹窗区域 ========== -->
<!-- 1. 一级：观看视频 or 直接玩 -->
<div class="modal" id="modalFirst"><div class="modal-content">
    <h3>选择操作</h3>
    <button id="watchVideoBtn">观看操控视频</button>
    <button id="directPlayBtn" class="primary">直接玩</button>
</div></div>

<!-- 2. 视频播放 -->
<div class="modal" id="modalVideo"><div class="modal-content">
    <h3>操控演示</h3>
    <video src="video2.mp4" controls></video>
    <button onclick="closeModal('modalVideo')">关闭</button>
</div></div>

<!-- 3. 选择套餐 -->
<div class="modal" id="modalPrice"><div class="modal-content">
    <h3>选择套餐</h3>
    <button data-price="10" data-time="30">10元 / 30分钟</button>
    <button data-price="5"  data-time="10">5元 / 10分钟</button>
    <button onclick="closeModal('modalPrice')">取消</button>
</div></div>

<!-- 4. 支付方式 -->
<div class="modal" id="modalPay"><div class="modal-content">
    <h3>选择支付方式</h3>
    <button class="payOption" data-channel="wechat">微信</button>
    <button class="payOption" data-channel="alipay">支付宝</button>
    <button class="payOption" data-channel="bank">银行卡</button>
    <button onclick="closeModal('modalPay')">返回</button>
</div></div>

<!-- 5. 排队中 -->
<div class="modal" id="modalQueue"><div class="modal-content">
    <h3>排队中</h3>
    <p>您的编号：<span id="queueNum">----</span></p>
    <p>前面还有 <span id="queueAhead">--</span> 人</p>
    <p>预计等待时间：<span id="queueTime">--:--</span></p>
    <div id="queueLoading" class="loading" style="margin:10px auto;display:none"></div>
    <button onclick="closeModal('modalQueue')">关闭</button>
</div></div>

<script>
// 全局变量
let currentPrice = 0;
let currentTime = 0;
let refreshInterval = null;

/*========== 工具：打开 / 关闭弹窗 ==========*/
function openModal(id){ 
    closeAllModal(); 
    document.getElementById(id).classList.add('active'); 
}
function closeModal(id){ 
    document.getElementById(id).classList.remove('active'); 
    if (id === 'modalQueue' && refreshInterval) {
        clearInterval(refreshInterval);
        refreshInterval = null;
    }
}
function closeAllModal(){ 
    document.querySelectorAll('.modal').forEach(m=>m.classList.remove('active')); 
    if (refreshInterval) {
        clearInterval(refreshInterval);
        refreshInterval = null;
    }
}
document.querySelectorAll('.modal').forEach(modal=>{ 
    modal.addEventListener('click',function(e){ 
        if(e.target===modal) closeModal(modal.id); 
    }); 
});

/*========== 底部导航切换 ==========*/
document.querySelectorAll('.tabbar .item').forEach(btn=>{
    btn.addEventListener('click', function(){
        document.querySelectorAll('.tabbar .item').forEach(b=>b.classList.remove('active'));
        this.classList.add('active');
        document.querySelectorAll('.page').forEach(p=>p.classList.remove('active'));
        document.getElementById(this.dataset.page).classList.add('active');
    });
});

/*========== 我要玩 ==========*/
document.getElementById('btnWantPlay').onclick = ()=> openModal('modalFirst');
document.getElementById('watchVideoBtn').onclick = ()=>{ closeModal('modalFirst'); openModal('modalVideo'); };
document.getElementById('directPlayBtn').onclick = ()=>{ closeModal('modalFirst'); openModal('modalPrice'); };

/*========== 支付流程 ==========*/
document.querySelectorAll('#modalPrice button[data-price]').forEach(btn=>{
    btn.addEventListener('click',function(){
        currentPrice = parseInt(this.dataset.price);
        currentTime  = parseInt(this.dataset.time);
        closeModal('modalPrice');
        openModal('modalPay');
    });
});

document.querySelectorAll('.payOption').forEach(btn=>{
    btn.addEventListener('click',async function(){
        const channel = this.dataset.channel;
        const loadingElem = document.getElementById('queueLoading');
        const closeBtn = document.querySelector('#modalQueue button');
        
        closeModal('modalPay');
        openModal('modalQueue');
        loadingElem.style.display = 'block';
        closeBtn.style.display = 'none';
        
        try {
            // 模拟支付处理时间
            await new Promise(resolve => setTimeout(resolve, 1500));
            await createOrder(currentPrice, currentTime);
        } catch (error) {
            alert('支付失败：' + error.message);
        } finally {
            loadingElem.style.display = 'none';
            closeBtn.style.display = 'block';
        }
    });
});

/*========== 模拟支付按钮（测试用） ==========*/
async function simulatePay(type){
    const price = type===1?10:5;
    const time  = type===1?30:10;
    
    openModal('modalQueue');
    const loadingElem = document.getElementById('queueLoading');
    const closeBtn = document.querySelector('#modalQueue button');
    loadingElem.style.display = 'block';
    closeBtn.style.display = 'none';
    
    try {
        await createOrder(price, time);
    } catch (error) {
        alert('支付失败：' + error.message);
    } finally {
        loadingElem.style.display = 'none';
        closeBtn.style.display = 'block';
    }
}

/*========== 创建订单 → 排队 ==========*/
async function createOrder(price, time){
    try {
        const res = await fetch('/api/createOrder', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ price, time })
        });
        
        const data = await res.json();
        
        if(data.ok){
            updateLiveInfo(data);
            
            // 每5秒刷新一次排队信息
            if (refreshInterval) clearInterval(refreshInterval);
            refreshInterval = setInterval(async ()=>{
                try {
                    const r = await fetch('/api/queueInfo?id=' + data.id);
                    const d = await r.json();
                    if(d.ok){ 
                        updateLiveInfo(d); 
                    } else { 
                        clearInterval(refreshInterval);
                        refreshInterval = null;
                    }
                } catch (error) {
                    console.error('刷新排队信息失败:', error);
                }
            }, 5000);
        } else {
            throw new Error(data.msg || '订单创建失败');
        }
    } catch (error) {
        closeModal('modalQueue');
        throw error;
    }
}

function updateLiveInfo(d){
    document.getElementById('queueNum').textContent = d.orderNum;
    document.getElementById('queueAhead').textContent = d.ahead;
    document.getElementById('queueTime').textContent = d.waitTime;
    document.getElementById('liveInfo').textContent = `当前编号${d.orderNum}，还有${d.ahead}人，预计排队${d.waitTime}`;
}

// 页面加载时初始化
document.addEventListener('DOMContentLoaded', function() {
    console.log('机器狗排队系统客户端已加载');
});
</script>
</body>
</html>
